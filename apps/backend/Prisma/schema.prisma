datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// ──────────────────────────────────────────────────────────────
//   ENUMS
// ──────────────────────────────────────────────────────────────
//

enum TypeSlot {
  HORS
  PRIS
  LIBRE
  BLOQUE
}

enum PaiementStatus {
  EN_ATTENTE
  EN_COURS
  SUCCES
  ECHEC
  REMBOURSE
}

//
// ──────────────────────────────────────────────────────────────
//   PATIENT
// ──────────────────────────────────────────────────────────────
//

model Patient {
  id             Int       @id @default(autoincrement())
  nom            String
  prenom         String
  email          String    @unique
  motDePasse     String
  telephone      String?
  resetToken     String?
  resetExpires   DateTime?
  adresse        String?

  // ✅ Stockage STRICT sans fuseau ni heure
  // Format ISO : YYYY-MM-DD
  dateNaissance  String

  emailVerified      Boolean   @default(false)
  verificationCode   String?
  verificationExpire DateTime?

  rdvs         RendezVous[] @relation("PatientRdv")
  documents    Document[]
  proches      Proche[]
  paiements    Paiement[] @relation("PatientPaiement")

  formulaires  FormulairePreconsultation[]

  latitude     Float?
  longitude    Float?

  favoris      PatientFavori[]

  avis         AvisMedecin[]

  notePatient  String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([nom, prenom, dateNaissance])
}

//
// ──────────────────────────────────────────────────────────────
//   CABINET
// ──────────────────────────────────────────────────────────────
//

model Cabinet {
  id        Int      @id @default(autoincrement())
  nom       String
  adresse   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  medecins      Medecin[]
  conversations Conversation[]
  secretaires   Secretaire[]
}

//
// ──────────────────────────────────────────────────────────────
//   MEDECIN
// ──────────────────────────────────────────────────────────────
//

model Medecin {
  id         Int      @id @default(autoincrement())
  nom        String
  prenom     String
  email      String   @unique
  motDePasse String?
  telephone  String?
  specialite String?
  adresseCabinet String?
  rpps           String?

  latitude   Float?
  longitude  Float?

  accepteNouveauxPatients Boolean @default(true)
  statut       String @default("en_attente")
  photoUrl     String?

  horaires     Json?
  horairesReference Json?

  bio          String?
  typeExercice String?
  siret        String?
  adresseFacturation String?

  resetToken   String?
  resetExpires DateTime?

  cabinetId Int?
  cabinet   Cabinet? @relation(fields: [cabinetId], references: [id])

  rdvs       RendezVous[]
  messages   Message[]
  conversations ConversationParticipant[]
  documents  Document[]
  secretaires Secretaire[] @relation("MedecinSecretaire")

  stripeAccountId      String? @unique
  stripeOnboardingDone Boolean @default(false)
  paiements Paiement[]

  formulaires FormulairePreconsultation[]
  avisMedecin   AvisMedecin[]
  favorisRecus  PatientFavori[]

  patientsCSV MedecinPatientCSV[]

  horairesExceptionnels HorairesExceptionnels[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ──────────────────────────────────────────────────────────────
//   HORAIRES EXCEPTIONNELS
// ──────────────────────────────────────────────────────────────
//

model HorairesExceptionnels {
  id        Int      @id @default(autoincrement())
  medecinId Int
  date      DateTime
  horaires  Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  medecin   Medecin @relation(fields: [medecinId], references: [id], onDelete: Cascade)

  @@unique([medecinId, date])
  @@index([medecinId, date])
}

//
// ──────────────────────────────────────────────────────────────
//   RENDEZ-VOUS
// ──────────────────────────────────────────────────────────────
//

model RendezVous {
  id       Int      @id @default(autoincrement())
  date     DateTime
  heure    String
  motif    String?

  typeSlot TypeSlot @default(HORS)

  rappelEnvoye Boolean @default(false)

  typeConsultation String @default("PRESENTIEL")
  visioRoomName    String?
  statutVisio      String @default("aucun")

  patientId Int?
  patient   Patient? @relation("PatientRdv", fields: [patientId], references: [id])

  procheId  Int?
  proche    Proche?  @relation("ProcheRdv", fields: [procheId], references: [id])

  medecinId Int?
  medecin   Medecin? @relation(fields: [medecinId], references: [id])

  paiement   Paiement?
  formulaire FormulairePreconsultation?

  // ✅ AJOUT — identité patient hors cabinet / CSV
  patientIdentity Json?

  createdAt DateTime @default(now())
}

//
// ──────────────────────────────────────────────────────────────
//   FORMULAIRE PRÉ-CONSULTATION
// ──────────────────────────────────────────────────────────────
//

model FormulairePreconsultation {
  id        Int       @id @default(autoincrement())

  rdvId     Int       @unique
  rdv       RendezVous @relation(fields: [rdvId], references: [id])

  medecinId Int
  medecin   Medecin    @relation(fields: [medecinId], references: [id])

  patientId Int
  patient   Patient    @relation(fields: [patientId], references: [id])

  reponses  Json?
  rempli    Boolean    @default(false)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

//
// ──────────────────────────────────────────────────────────────
//   DOCUMENTS
// ──────────────────────────────────────────────────────────────
//

model Document {
  id        Int      @id @default(autoincrement())
  type      String
  url       String
  filename  String?
  createdAt DateTime @default(now())

  medecinId Int
  medecin   Medecin  @relation(fields: [medecinId], references: [id])

  patientId Int?
  patient   Patient? @relation(fields: [patientId], references: [id])

  procheId  Int?
  proche    Proche?  @relation(fields: [procheId], references: [id])

  @@index([patientId])
  @@index([procheId])
}

//
// ──────────────────────────────────────────────────────────────
//   MESSAGERIE
// ──────────────────────────────────────────────────────────────
//

model Conversation {
  id           Int                        @id @default(autoincrement())
  name         String?
  cabinetId    Int
  cabinet      Cabinet                    @relation(fields: [cabinetId], references: [id])
  messages     Message[]
  participants ConversationParticipant[]
  createdAt    DateTime                   @default(now())
}

model ConversationParticipant {
  id             Int @id @default(autoincrement())
  conversationId Int
  medecinId      Int

  conversation Conversation @relation(fields: [conversationId], references: [id])
  medecin      Medecin      @relation(fields: [medecinId], references: [id])

  @@unique([conversationId, medecinId])
}

model Message {
  id        Int      @id @default(autoincrement())
  contenu   String
  createdAt DateTime @default(now())

  fichiers  Json?

  fromId Int
  from   Medecin @relation(fields: [fromId], references: [id])

  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
}

//
// ──────────────────────────────────────────────────────────────
//   PROCHES
// ──────────────────────────────────────────────────────────────
//

model Proche {
  id             Int       @id @default(autoincrement())
  patientId      Int
  patient        Patient   @relation(fields: [patientId], references: [id])

  prenom         String
  nom            String

  // ✅ String ISO sans fuseau
  dateNaissance  String

  relation       String
  notesSante     String?

  rdvs           RendezVous[] @relation("ProcheRdv")
  documents      Document[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([nom, prenom, dateNaissance])
}

//
// ──────────────────────────────────────────────────────────────
//   SECRETAIRE
// ──────────────────────────────────────────────────────────────
//

model Secretaire {
  id         Int      @id @default(autoincrement())
  nom        String
  prenom     String
  email      String   @unique
  motDePasse String
  telephone  String?

  resetToken   String?
  resetExpires DateTime?

  cabinetId Int
  cabinet   Cabinet @relation(fields: [cabinetId], references: [id])

  medecins  Medecin[] @relation("MedecinSecretaire")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ──────────────────────────────────────────────────────────────
//   AUDIT LOG
// ──────────────────────────────────────────────────────────────
//

model AuditLog {
  id          Int       @id @default(autoincrement())
  userId      Int?
  role        String
  action      String
  targetType  String?
  targetId    Int?
  ip          String?
  success     Boolean
  timestamp   DateTime   @default(now())
}

//
// ──────────────────────────────────────────────────────────────
//   PAIEMENT
// ──────────────────────────────────────────────────────────────
//

model Paiement {
  id                    Int       @id @default(autoincrement())
  montantCents          Int
  devise                String    @default("eur")

  status                PaiementStatus @default(EN_ATTENTE)

  stripePaymentIntentId String    @unique
  stripeChargeId        String?
  platformFeeCents      Int       @default(0)

  patientId             Int?
  patient               Patient?   @relation("PatientPaiement", fields: [patientId], references: [id])

  medecinId             Int
  medecin               Medecin    @relation(fields: [medecinId], references: [id])

  rendezVousId          Int        @unique
  rendezVous            RendezVous @relation(fields: [rendezVousId], references: [id])

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
}

//
// ──────────────────────────────────────────────────────────────
//   FAVORIS & AVIS
// ──────────────────────────────────────────────────────────────
//

model PatientFavori {
  id        Int      @id @default(autoincrement())
  patientId Int
  patient   Patient  @relation(fields: [patientId], references: [id])
  medecinId Int
  medecin   Medecin  @relation(fields: [medecinId], references: [id])
  createdAt DateTime @default(now())
  @@unique([patientId, medecinId])
}

model AvisMedecin {
  id          Int      @id @default(autoincrement())
  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id])
  medecinId   Int
  medecin     Medecin  @relation(fields: [medecinId], references: [id])
  note        Float
  commentaire String?
  createdAt   DateTime @default(now())
  @@unique([patientId, medecinId])
}

model MedecinPatientCSV {
  id            Int      @id @default(autoincrement())
  medecinId     Int
  nom           String
  prenom        String

  // ✅ String ISO sans fuseau
  dateNaissance String

  medecin     Medecin  @relation(fields: [medecinId], references: [id])

  @@index([medecinId])
  @@index([nom, prenom, dateNaissance])
}
