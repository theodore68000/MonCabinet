datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// ──────────────────────────────────────────────────────────────
//   PATIENT
// ──────────────────────────────────────────────────────────────
//

model Patient {
  id             Int       @id @default(autoincrement())
  nom            String
  prenom         String
  email          String    @unique
  motDePasse     String
  telephone      String?
  resetToken     String?
  resetExpires   DateTime?
  adresse        String?
  anneeNaissance Int?

  medecinTraitantId Int?
  medecinTraitant   Medecin? @relation("MedecinTraitant", fields: [medecinTraitantId], references: [id])

  rdvs RendezVous[] @relation("PatientRdv")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ──────────────────────────────────────────────────────────────
//   CABINET
// ──────────────────────────────────────────────────────────────
//

model Cabinet {
  id        Int      @id @default(autoincrement())
  nom       String
  adresse   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  medecins      Medecin[]
  conversations Conversation[]
}

//
// ──────────────────────────────────────────────────────────────
//   MEDECIN
// ──────────────────────────────────────────────────────────────
//

model Medecin {
  id         Int     @id @default(autoincrement())
  nom        String
  prenom     String
  email      String  @unique
  motDePasse String?
  telephone  String?
  specialite String?

  adresseCabinet String?
  rpps           String?

  accepteNouveauxPatients Boolean @default(true)

  statut             String  @default("en_attente")
  photoUrl           String?
  horaires           Json?
  bio                String?
  typeExercice       String?
  siret              String?
  adresseFacturation String?

  resetToken   String?
  resetExpires DateTime?

  cabinetId Int?
  cabinet   Cabinet? @relation(fields: [cabinetId], references: [id])

  patientsTraitant Patient[]    @relation("MedecinTraitant")
  rdvs             RendezVous[] @relation("MedecinRdv")

  // Nouvelle relation pour la messagerie moderne
  messages        Message[]
  conversations   ConversationParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ──────────────────────────────────────────────────────────────
//   RENDEZVOUS
// ──────────────────────────────────────────────────────────────
//

model RendezVous {
  id     Int      @id @default(autoincrement())
  date   DateTime
  heure  String
  motif  String?
  statut String   @default("confirmé")

  patientId Int?
  medecinId Int?

  patient Patient? @relation("PatientRdv", fields: [patientId], references: [id])
  medecin Medecin? @relation("MedecinRdv", fields: [medecinId], references: [id])
}

//
// ──────────────────────────────────────────────────────────────
//   MESSAGERIE — CONVERSATIONS + GROUPES
// ──────────────────────────────────────────────────────────────
//

model Conversation {
  id            Int                       @id @default(autoincrement())
  name          String?                   // null = conversation privée, non-null = groupe
  cabinetId     Int
  cabinet       Cabinet                   @relation(fields: [cabinetId], references: [id])
  messages      Message[]
  participants  ConversationParticipant[]
  createdAt     DateTime                  @default(now())
}

model ConversationParticipant {
  id             Int           @id @default(autoincrement())
  conversationId Int
  medecinId      Int

  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  medecin        Medecin       @relation(fields: [medecinId], references: [id])

  @@unique([conversationId, medecinId]) // évite doublon
}

model Message {
  id             Int      @id @default(autoincrement())
  contenu        String
  createdAt      DateTime @default(now())

  fromId         Int
  from           Medecin  @relation(fields: [fromId], references: [id])

  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
}
